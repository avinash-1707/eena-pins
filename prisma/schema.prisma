generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  BRAND
  ADMIN
}

model User {
  id                String  @id @default(uuid())

  email             String? @unique
  phone             String? @unique

  username          String  @unique
  description       String
  name              String?
  avatarUrl         String?

  provider          String?
  providerAccountId String?

  role Role @default(USER)

  createdAt DateTime @default(now())

  ratings     UserRating[]
  collections Collection[]
  products    Product[]    @relation("BrandProducts")
}


model PhoneOTP {
  id          String   @id @default(uuid())
  phone       String
  otpHash     String
  expiresAt   DateTime
  used        Boolean  @default(false)
  attempts    Int      @default(0)

  @@index([phone])
}

model Product {
  id              String  @id @default(uuid())
  name            String
  price           Int     @default(0)
  imageUrl        String
  category        String
  description     String
  warrantyMonths  Int?
  freeShippingOn  Boolean @default(false)
  returnAvailable Boolean @default(false)

  // Brand ownership
  brandId String
  brand   User   @relation("BrandProducts", fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  details     ProductDetail?
  ratings     UserRating[]
  collections CollectionProduct[]

  @@index([brandId])
}

model ProductDetail {
  id        String @id @default(uuid())
  productId String @unique

  brand       String?
  material    String?
  keyFeatures String[] // array of strings
  moreOptions Json? // key-value pairs
  rating      Float?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model UserRating {
  id        String  @id @default(uuid())
  userId    String
  productId String
  rating    Int
  review    String?

  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId]) // one rating per user per product
}

model Collection {
  id       String  @id @default(uuid())
  name     String
  isPublic Boolean @default(true)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  products CollectionProduct[]

  @@unique([userId, name]) // user can't create same collection twice
}

model CollectionProduct {
  id           String @id @default(uuid())
  collectionId String
  productId    String

  createdAt DateTime @default(now())

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId]) // no duplicate bookmarks
}
